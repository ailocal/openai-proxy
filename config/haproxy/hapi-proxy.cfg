global
    log 127.0.0.1:514 local0 debug
    log 127.0.0.1:514 local1 notice

default-path config

defaults
    log     global
    mode    http
    option  httplog
    log-format "%ci:%cp [%tr] %ft %b/%s \"%r\" -> %ST %B \"%hr\""
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend ailocal_proxy
    bind :2020
    mode http
    default_backend default_backend

    # ACLs for different endpoints
    acl is_whisper path_beg /v1/audio/transcriptions
    acl is_whisper path_beg /audio/transcriptions
    acl is_tts path_beg /v1/audio/speech
    acl is_openai path_beg /v1
    acl is_llm path_beg /v1/chat/completions

    # Route requests based on path
    use_backend whisper_backend if is_whisper
    use_backend tts_backend if is_tts
    use_backend ollama_backend if is_llm
    use_backend openai_backend if is_openai

backend whisper_backend
    mode http
    server whisper_local api.ailocal.org:443 ssl verify none
    http-request set-path /audio/transcriptions

backend tts_backend
    mode http
    server tts_local studio:8880 check

backend ollama_backend
    mode http
    server ollama_local studio:11434 check

backend openai_backend
    mode http
    server openai api.openai.com:443 ssl verify none

backend default_backend
    mode http
    errorfile 503 errors/503.http
